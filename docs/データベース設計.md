# データベース設計

## 概要

Raindrop AIのデータベーススキーマは、Drizzle ORMを使用して定義されています。

## テーブル構成

### 1. users テーブル

ユーザー情報とRaindrop OAuth トークンを保存します。

| カラム | 型 | 説明 |
|-------|---|------|
| id | UUID | 主キー |
| email | TEXT | メールアドレス（ユニーク） |
| name | TEXT | ユーザー名 |
| image | TEXT | プロフィール画像URL |
| raindrop_access_token | TEXT | Raindropアクセストークン（暗号化済み） |
| raindrop_refresh_token | TEXT | Raindropリフレッシュトークン（暗号化済み） |
| raindrop_token_expires_at | TIMESTAMPTZ | トークン有効期限 |
| created_at | TIMESTAMPTZ | 作成日時 |
| updated_at | TIMESTAMPTZ | 更新日時 |

### 2. raindrops テーブル

Raindrop.ioから取り込んだ記事を保存します。

| カラム | 型 | 説明 |
|-------|---|------|
| user_id | UUID | ユーザーID（複合主キー1） |
| id | BIGINT | Raindrop記事ID（複合主キー2） |
| title | TEXT | 記事タイトル |
| link | TEXT | 記事URL |
| excerpt | TEXT | 抜粋 |
| cover | TEXT | カバー画像URL |
| collection_id | BIGINT | コレクションID |
| tags | JSONB | タグ配列 |
| created_at_remote | TIMESTAMPTZ | Raindropでの作成日時 |
| synced_at | TIMESTAMPTZ | 同期日時 |
| deleted_at | TIMESTAMPTZ | 削除日時（論理削除） |

**主キー**: (user_id, id)

**インデックス**:
- idx_raindrops_user_id
- idx_raindrops_synced_at
- idx_raindrops_collection

### 3. summaries テーブル

Claude APIで生成した要約を保存します。

| カラム | 型 | 説明 |
|-------|---|------|
| id | UUID | 主キー |
| user_id | UUID | ユーザーID |
| raindrop_id | BIGINT | 記事ID |
| tone | TEXT | トーン（snarky/neutral/enthusiastic/casual） |
| summary | TEXT | 要約本文 |
| rating | INTEGER | 評価（1-5） |
| rating_reason | TEXT | 評価理由 |
| facts_json | JSONB | 事実抽出結果 |
| model | TEXT | 使用モデル |
| status | TEXT | ステータス（pending/processing/completed/failed） |
| error | TEXT | エラーメッセージ |
| created_at | TIMESTAMPTZ | 作成日時 |
| updated_at | TIMESTAMPTZ | 更新日時 |

**ユニーク制約**: (user_id, raindrop_id, tone)

**インデックス**:
- idx_summaries_user_raindrop
- idx_summaries_status
- idx_summaries_created

### 4. api_usage テーブル

API使用状況（コスト追跡）を保存します。

| カラム | 型 | 説明 |
|-------|---|------|
| id | UUID | 主キー |
| user_id | UUID | ユーザーID |
| summary_id | UUID | 要約ID（NULL可） |
| api_provider | TEXT | APIプロバイダー（anthropic/raindrop/extract） |
| model | TEXT | モデル名 |
| input_tokens | INTEGER | 入力トークン数 |
| output_tokens | INTEGER | 出力トークン数 |
| cost_usd | DECIMAL(10,6) | コスト（ドル） |
| created_at | TIMESTAMPTZ | 作成日時 |

**インデックス**:
- idx_api_usage_user

## Row Level Security (RLS)

### 概要

本番環境（Supabase使用時）では、RLSポリシーを有効化してマルチユーザー環境でのデータ分離を実現します。

### 注意事項

⚠️ **ローカル開発環境（Docker Compose）では、RLSポリシーは適用されません。**

ローカルPostgreSQLには`auth.uid()`関数が存在しないため、RLSポリシーのSQLは実行エラーになります。
ローカル開発では、アプリケーションレベルでのフィルタリング（WHERE user_id = ?）に依存します。

### RLSポリシー（Supabase用）

各テーブルに以下のポリシーを適用：

- **SELECT**: `auth.uid() = user_id`
- **INSERT**: `auth.uid() = user_id`
- **UPDATE**: `auth.uid() = user_id`
- **DELETE**: `auth.uid() = user_id`

本番環境（Supabase）へのデプロイ時に、`src/db/migrations/0001_rls_policies.sql`を手動で実行してください。

## マイグレーション

### ローカル開発環境

```bash
# スキーマからマイグレーションSQLを生成
docker compose exec web npm run db:generate

# DBにマイグレーションを適用
docker compose exec web npm run db:push

# Drizzle Studioでデータを確認
docker compose exec web npm run db:studio
```

### 本番環境（Supabase）

1. Drizzle Kitでマイグレーションを生成
2. 生成されたSQLをSupabase SQL Editorで実行
3. RLSポリシーSQLを手動で実行（`0001_rls_policies.sql`）

## リレーション

```
users (1) --< (N) raindrops
users (1) --< (N) summaries
users (1) --< (N) api_usage
summaries (1) --< (N) api_usage
```

## 型定義

Drizzle ORMから自動生成される型：

```typescript
import { User, NewUser, Raindrop, NewRaindrop, Summary, NewSummary, ApiUsage, NewApiUsage } from "@/db/schema"

// SELECT時の型
const user: User = await db.query.users.findFirst()

// INSERT時の型
const newUser: NewUser = {
  email: "test@example.com",
  name: "Test User"
}
```

## データ保持ポリシー

- **論理削除**: raindropsテーブルは`deleted_at`カラムで論理削除
- **カスケード削除**: usersテーブル削除時、関連データも全て削除
- **バックアップ**: Supabaseの自動バックアップ機能を利用（本番環境）

## パフォーマンス最適化

### インデックス戦略

- ユーザーIDでのフィルタリングが頻繁なため、全テーブルに`user_id`インデックスを作成
- 日時での並び替えが多いため、`synced_at`や`created_at`にもインデックスを作成
- JSONBカラム（tags）はGINインデックスで高速検索（本番環境で設定）

### クエリ最適化

- N+1問題を避けるため、Drizzle ORMのリレーション機能を活用
- ページネーション時は必ずLIMIT/OFFSETを使用
- 大量データ取得時はストリーミングを検討

## トラブルシューティング

### マイグレーションエラー

**問題**: `auth.uid() does not exist`

**原因**: ローカルPostgreSQLにはauth.uid()関数がない

**解決策**: RLSポリシーのSQLはスキップし、ローカルではRLS無効で開発

### 接続エラー

**問題**: `Cannot connect to database`

**原因**: PostgreSQLコンテナが起動していない

**解決策**: `docker compose up -d db` でDBを起動

### マイグレーション競合

**問題**: マイグレーションファイルの競合

**解決策**: `src/db/migrations/`を削除して再生成
